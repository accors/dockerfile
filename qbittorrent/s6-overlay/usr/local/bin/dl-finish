#!/bin/bash

send_notify() {
    local hash="$1"
    local torrent_info=$($cmd_curl "${api_url_base}/torrents/info?hashes=${hash}" | jq .[0])
    local torrent_properties=$($cmd_curl "${api_url_base}/torrents/properties?hash=${hash}")
    local torrent_files=$($cmd_curl "${api_url_base}/torrents/files?hash=${hash}")

    local torrent_name=$(echo "$torrent_info" | jq -r .name)
    local save_path=$(echo "$torrent_properties" | jq -r .save_path)
    local category=$(echo "$torrent_info" | jq -r .category)
    local total_size=$(echo "$torrent_properties" | jq .total_size | xargs -I {} nice-size {})
    local files_sum=$(echo $torrent_files | jq '.|length')
    local addition_date=$(echo "$torrent_properties" | jq .addition_date)
    local addition_date_format=$(date +'%Y-%m-%d %H:%M:%S' -d @$addition_date)
    local completion_date=$(echo "$torrent_properties" | jq .completion_date)
    local completion_date_format=$(date +'%Y-%m-%d %H:%M:%S' -d @$completion_date)
    local download_time=$(nice-time $(($completion_date - $addition_date)))

    notify "种子下载完成" "种子名称：$torrent_name\n保存路径：$save_path\n种子分类：$category\n文件大小：$total_size\n文件数量：$files_sum\n开始时间：$addition_date_format\n完成时间：$completion_date_format\n下载用时：$download_time\n"
}

if [[ $# -ne 1 ]]; then
    echo "(W) $(date +'%Y-%m-%dT%H:%M:%S') - [$(basename $0)] 传入参数不正确，请只传入HASH值，形如：dl-finish \"%I\"..."
else
    . /usr/local/bin/share
    torrent_hash="$1"
    echo "(N) $(date +'%Y-%m-%dT%H:%M:%S') - [$(basename $0)] 将刚下载完成的种子进行分类..."
    auto-cat -i "$torrent_hash"
    if [[ $DL_FINISH_NOTIFY != false ]]; then
        echo "(N) $(date +'%Y-%m-%dT%H:%M:%S') - [$(basename $0)] 发送种子下载完成的通知消息..."
        send_notify "$torrent_hash"
    else
        echo "(W) $(date +'%Y-%m-%dT%H:%M:%S') - [$(basename $0)] 已设置为不发送种子下载完成的通知消息..."
    fi
fi
